import{u as H,r as a,j as e,s as K,a as Q,l as ee,h as te}from"./index-C3BZ17kn.js";const J=220,E=[{id:"intro-1",text:"J'espère que ça va toujours, te voici au niveau 7, tu avances super bien!",durationMs:2400},{id:"intro-2",text:"Je t'ai bien cerné désormais, j'ai envie d'être honnête avec toi, pour qu'on puisse avancer dans la bonne direction",durationMs:3600},{id:"job-prompt",text:"Dis-moi un métier et je te dirai si oui ou non tu es fait pour ce métier",durationMs:3200,requiresEvaluation:!0},{id:"closing",text:"Au niveau 14 tu auras la possibilité d'aller beaucoup plus loin, en m'indiquant tous les métiers que tu souhaites. Encore une fois je serai intransigeante et la plus honnête possible.",durationMs:4200,closing:!0}],U=E.findIndex(t=>t.requiresEvaluation);function re(t,i="zelia"){try{if(t!=null&&t.avatar_url&&typeof t.avatar_url=="string")return t.avatar_url;if(t!=null&&t.avatar&&typeof t.avatar=="string")return t.avatar;if(t!=null&&t.avatar_json){let n=t.avatar_json;if(typeof n=="string")try{n=JSON.parse(n)}catch{}if(n&&typeof n=="object"){if(n.url&&typeof n.url=="string")try{const s=new URL(n.url);return s.searchParams.has("seed")||s.searchParams.set("seed",String(i)),s.searchParams.has("size")||s.searchParams.set("size","300"),s.toString()}catch{}const o=new URLSearchParams;return o.set("seed",String(i)),Object.entries(n).forEach(([s,c])=>{c!=null&&c!==""&&o.set(s,String(c))}),o.has("size")||o.set("size","300"),`https://api.dicebear.com/9.x/lorelei/svg?${o.toString()}`}}}catch{}return`https://api.dicebear.com/9.x/lorelei/svg?${new URLSearchParams({seed:String(i),size:"300",radius:"15"}).toString()}`}function ae(t,i={}){try{const l=new URL(t);return/api\.dicebear\.com/.test(l.host)&&/\/lorelei\/svg/.test(l.pathname)?(Object.entries(i).forEach(([o,s])=>{s==null||s===""?l.searchParams.delete(o):l.searchParams.set(o,String(s))}),l.searchParams.has("size")||l.searchParams.set("size","300"),l.toString()):t}catch{return t}}function se(t,i){const[l,n]=a.useState(""),[o,s]=a.useState(!1),c=a.useRef(null),g=a.useRef(null);return a.useEffect(()=>{const b=t||"";n(""),s(!1);let N=0;const v=Math.max(15,Math.floor(i/Math.max(1,b.length)));return c.current=setInterval(()=>{N+=1,n(b.slice(0,N)),N>=b.length&&clearInterval(c.current)},v),g.current=setTimeout(()=>{clearInterval(c.current),n(b),s(!0)},Math.max(i,(b.length+1)*v)),()=>{c.current&&clearInterval(c.current),g.current&&clearTimeout(g.current)}},[t,i]),{text:l,done:o,skip:()=>{c.current&&clearInterval(c.current),g.current&&clearTimeout(g.current),n(t||""),s(!0)}}}function ne(t){if(!t)return"";const i=t.toLowerCase();return i.startsWith("o")?"Oui":i.startsWith("n")?"Non":t}function ie(t,i=100){if(!t)return"";const l=t.trim().split(/\s+/);return l.length<=i?t.trim():`${l.slice(0,i).join(" ")}…`}function oe(){const t=H(),[i,l]=a.useState(!0),[n,o]=a.useState(""),[s,c]=a.useState(""),[g,R]=a.useState(!1),[b,N]=a.useState(0),[v,L]=a.useState(""),[y,P]=a.useState(null),[I,j]=a.useState(""),[w,q]=a.useState(!1),[A,C]=a.useState(!1),[V,M]=a.useState(!1),z=a.useRef(null),D=()=>{var r;(r=z.current)==null||r.focus()};a.useEffect(()=>{let r=!1;return(async()=>{var x;try{const{data:h}=await K.auth.getUser(),u=h==null?void 0:h.user;if(!u){t("/login",{replace:!0});return}const p=await Q.getProfile().catch(()=>null);if(r)return;const k=((x=p==null?void 0:p.data)==null?void 0:x.profile)??(p==null?void 0:p.data)??null;c(re(k,u.id||"zelia"))}catch(h){console.error("Niveau7 profile load failed",h),r||o("Impossible de charger ce niveau pour le moment. Réessaie plus tard.")}finally{r||l(!1)}})(),()=>{r=!0}},[t]);const d=E[Math.min(b,E.length-1)],{text:$,done:f,skip:_}=se((d==null?void 0:d.text)||"",(d==null?void 0:d.durationMs)||1500),S=b>=(U===-1?Number.POSITIVE_INFINITY:U),F=!!(d!=null&&d.requiresEvaluation),T=b>=E.length-1,X=!f||F&&!y||w;a.useEffect(()=>{if(!d||f){R(!1);return}const r=setInterval(()=>R(m=>!m),200);return()=>clearInterval(r)},[d,f]);const O=!!(d!=null&&d.closing),Z=a.useMemo(()=>{if(!s)return"";let r=s;try{const x=new URL(r);if(!(/api\.dicebear\.com/.test(x.host)&&/\/lorelei\/svg/.test(x.pathname)))return r}catch{return r}return ae(r,{mouth:f?null:g?"happy08":"happy01",eyes:O?"variant16":null})},[s,g,f,O]);a.useEffect(()=>{I&&v.trim().length>=3&&j("")},[v,I]),a.useEffect(()=>{S&&b===U&&f&&D()},[S,b,f]);const B=()=>{if(!f){_();return}if(F&&!y){j("Indique un métier et lance l'analyse avant de continuer."),D();return}j(""),N(r=>Math.min(r+1,E.length-1))},G=async r=>{var x,h;if(r.preventDefault(),w)return;const m=v.trim();if(m.length<3){j("Indique un métier valide (3 caractères minimum)."),D();return}j(""),q(!0);try{const{data:u}=await te.evaluateJob({job:m}),p=ne(u==null?void 0:u.verdict),k=ie(u==null?void 0:u.explanation);if(!p||!k)throw new Error("Réponse IA invalide");P({verdict:p,explanation:k})}catch(u){console.error("Level 7 evaluation failed",u);const p=((h=(x=u==null?void 0:u.response)==null?void 0:x.data)==null?void 0:h.error)||"Impossible de consulter Gemini pour ce métier. Réessaie dans un instant.";j(p),P(null)}finally{q(!1)}},W=async()=>{if(!T||!f){f||_();return}if(!A){C(!0),o("");try{await ee({minLevel:7,xpReward:J}),M(!0)}catch(r){console.error("Niveau7 levelUp failed",r),o("Impossible de valider le niveau pour le moment. Réessaie dans un instant.")}finally{C(!1)}}};if(i)return e.jsxs("div",{className:"p-6 text-center",children:[e.jsx("div",{className:"inline-block h-6 w-6 animate-spin rounded-full border-2 border-black border-t-transparent"}),e.jsx("p",{className:"mt-2 text-text-secondary",children:"Chargement du niveau 7…"})]});if(n)return e.jsx("div",{className:"p-6",children:e.jsx("div",{className:"rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700",children:n})});const Y=(r={})=>{const{locked:m=!1,emptyFallback:x}=r;return e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:G,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"job-input",className:"text-sm font-semibold text-gray-700",children:"Ton métier cible"}),e.jsx("input",{id:"job-input",ref:z,type:"text",value:v,onChange:h=>L(h.target.value),placeholder:"Ex: architecte d'intérieur, ingénieur en cybersécurité…",disabled:m||w,className:"w-full rounded-xl border border-gray-300 px-4 py-3 text-base text-gray-900 shadow-sm focus:border-black focus:outline-none focus:ring-2 focus:ring-black/10 disabled:cursor-not-allowed disabled:bg-gray-100"})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",children:[e.jsx("button",{type:"submit",disabled:m||w,className:"inline-flex items-center justify-center rounded-xl bg-[#c1ff72] px-5 py-3 text-base font-semibold text-black transition hover:bg-[#b3ff5d] disabled:cursor-not-allowed disabled:opacity-60",children:w?"Analyse en cours…":"Demander à Zélia"}),e.jsx("button",{type:"button",onClick:()=>{L(""),P(null),j("")},disabled:m||w||!v&&!y,className:"inline-flex items-center justify-center rounded-xl border border-gray-200 px-5 py-3 text-base font-semibold text-gray-700 transition hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-60",children:"Effacer"})]}),!m&&I&&e.jsx("div",{className:"rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700",children:I}),m&&e.jsx("div",{className:"rounded-xl border border-gray-200 bg-gray-50 px-4 py-3 text-sm text-gray-600",children:"Termine d'abord le dialogue à gauche avec Zélia pour débloquer cette étape."})]}),e.jsx("div",{className:"mt-6 rounded-2xl border border-dashed border-gray-200 bg-gray-50 p-4 text-sm text-gray-600",children:y?e.jsxs("div",{className:`rounded-2xl border px-5 py-4 text-base font-medium shadow-inner ${y.verdict==="Oui"?"border-emerald-200 bg-emerald-50 text-emerald-700":"border-red-200 bg-red-50 text-red-700"}`,children:[e.jsx("span",{className:"font-semibold",children:y.verdict}),e.jsxs("span",{className:"ml-2 text-gray-900",children:["— ",y.explanation]})]}):x?e.jsx("p",{children:x}):null})]})};return e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsx("div",{className:"mx-auto w-full max-w-none",children:e.jsxs("div",{className:"grid w-full grid-cols-1 items-stretch gap-6 lg:grid-cols-2",children:[e.jsx("div",{className:"rounded-3xl border border-gray-200 bg-white p-6 shadow-card md:p-8",children:e.jsxs("div",{className:"mt-6 flex flex-col items-center gap-6 md:flex-row md:items-start",children:[e.jsx("img",{src:Z,alt:"Avatar",className:"mx-auto h-40 w-40 rounded-2xl border border-gray-100 bg-white object-contain shadow-sm sm:h-48 sm:w-48 md:mx-0 md:h-64 md:w-64"}),e.jsxs("div",{className:"w-full flex-1",children:[e.jsxs("div",{className:"relative w-full rounded-2xl bg-black p-5 text-white",children:[e.jsx("div",{className:"min-h-[3.5rem] whitespace-pre-wrap text-base leading-relaxed md:text-lg",children:$}),e.jsx("div",{className:"absolute -left-2 top-6 h-0 w-0 border-b-8 border-r-8 border-t-8 border-b-transparent border-r-black border-t-transparent"})]}),e.jsxs("div",{className:"mt-6 flex flex-col gap-3 sm:flex-row sm:items-center",children:[!T&&e.jsx("button",{type:"button",onClick:B,disabled:X,className:"inline-flex items-center justify-center rounded-xl bg-black px-5 py-3 text-base font-semibold text-white transition hover:bg-black/90 disabled:cursor-not-allowed disabled:bg-gray-300",children:f?"Suivant":"Afficher toute la phrase"}),T&&e.jsx("button",{type:"button",onClick:W,disabled:A,className:"inline-flex items-center justify-center rounded-xl bg-[#c1ff72] px-5 py-3 text-base font-semibold text-black transition hover:bg-[#b3ff5d] disabled:cursor-not-allowed disabled:opacity-60",children:A?"Validation…":"Valider le niveau 7"}),e.jsxs("div",{className:"text-sm text-gray-400 sm:ml-auto",children:[J," XP"]})]})]})]})}),e.jsx("aside",{className:"flex h-full flex-col rounded-3xl border border-gray-200 bg-white p-6 shadow-card md:p-8",children:Y({locked:!S,emptyFallback:S?"":"Termine d'abord le dialogue pour débloquer cette étape."})})]})}),V&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 px-4",children:e.jsxs("div",{className:"relative w-full max-w-md rounded-3xl border border-gray-200 bg-white p-8 text-center shadow-2xl",children:[e.jsx("div",{className:"absolute -top-6 left-1/2 -translate-x-1/2 flex h-12 w-12 items-center justify-center rounded-full bg-[#c1ff72] text-2xl shadow-lg",children:"🎯"}),e.jsx("h3",{className:"mt-4 text-2xl font-extrabold text-gray-900",children:"Niveau 7 validé !"}),e.jsx("p",{className:"mt-2 text-gray-500",children:"Tu as affronté le verdict de Zélia. Direction le prochain niveau pour continuer ta progression."}),e.jsxs("div",{className:"mt-6 flex flex-col gap-3 sm:flex-row sm:justify-center",children:[e.jsx("button",{type:"button",onClick:()=>t("/app/activites"),className:"inline-flex items-center justify-center rounded-xl bg-[#c1ff72] px-5 py-3 text-base font-semibold text-black transition hover:bg-[#b3ff5d]",children:"Retour aux activités"}),e.jsx("button",{type:"button",onClick:()=>M(!1),className:"inline-flex items-center justify-center rounded-xl border border-gray-200 px-5 py-3 text-base font-semibold text-gray-700 transition hover:bg-gray-100",children:"Rester sur la page"})]})]})})]})}export{oe as default};
